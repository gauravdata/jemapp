<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2010 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Category layered navigation
 *
 * @see Mage_Catalog_Block_Layer_View
 */
?>
<?php if($this->canShowBlock()): ?>
<div class="block block-layered-nav">
    <div class="block-content">
        <?php echo $this->getStateHtml() ?>
        <?php if($this->canShowOptions()): ?>
            <dl id="narrow-by-list">
                <?php $_filters = $this->getFilters() ?>
                <?php foreach ($_filters as $_filter): ?>
                <?php if($_filter->getItemsCount() > 1): ?>
                    <dt><?php echo $this->__($_filter->getName()) ?></dt>
                    <dd>
						<a href="<?php echo Mage::helper('amshopby')->getFullUrl(array(), 1) ?>" class="clear-filter" title="<?php echo $this->__('clear') ?>"><?php echo $this->__('clear') ?></a>
						<div class="clearer">&nbsp;</div>
						<?php echo $_filter->getHtml() ?>
					</dd>
					<dd class="action-group">
						<div class="actions">
							<a href="#" onclick="return applyFilter()" class="button">Toepassen</a>
						</div>
					</dd>
                <?php endif; ?>
                <?php endforeach; ?>
            </dl>
            <script type="text/javascript">decorateDataList('narrow-by-list')</script>
        <?php endif; ?>
    </div>
	<script type="text/javascript">
		var filters = [];
		function handle(event){
			Event.stop(event);
			
			var el = Event.element(event);
			p = new Flog.UriParser(el.href);
			for (q in p.querystring) {
				if (typeof(p.querystring[q]) == 'function') continue;
				if (q == 'length') continue;
				if (q == 'rawQueryString') continue;
				var val = p.querystring[q].split(',');
				if (!filters[q]) {
					filters[q] = [];
				}
				if (el.hasClassName('amshopby-attr')) {
					for (var i=0;i<val.length;i++) {
						filters[q].push(val[i]);
					}
					//filters[q] = Array.concat(filters[q], val);
					filters[q].unique();
				} else {
					for (v in val) {
						delete(filters[q].splice(filters[q].indexOf(val[v]),1));
					}
					if (filters[q].length <= 0) delete(filters[q]);
				}
			}
			el.toggleClassName('amshopby-attr-selected');
			el.toggleClassName('amshopby-attr');

			var action = el.up('dd').nextSiblings()[0];
			$('narrow-by-list').select('dd.action-group').each(function(el){
				if (el != action) {
					el.hide();
				}
			});
			
			if (!action.visible()) {
				Effect.SlideDown(action,{ duration: .3 });
				//el.up('dd').nextSiblings()[0].show();
			}
			
		}
		$$('a.amshopby-attr').each(function(el){
			el.observe('click', handle);
		});
		$$('a.amshopby-attr-selected').each(function(el){
			el.observe('click', handle);
		});
		$('narrow-by-list').select('dd.action-group').each(function(el){
			el.hide();
		});
		function applyFilter() {
			p = new Flog.UriParser($$('a.amshopby-attr')[0].href);
			var url = p.pathname;
			var sep = '?';
			for (f in filters) {
				if (typeof(filters[f]) == 'function') continue;
				url += sep + f + '=' + filters[f].join(',');
				sep = '&';
			}
			window.location.href = url;
			return false;
		}
	</script>
</div>
<?php endif; ?>
