<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product list template
 *
 * @see Mage_Catalog_Block_Product_List
 */
?>
<?php
    /* Count for timer calculation declared here */
    $count = 1;
    $_productCollection=$this->getLoadedProductCollection();
    $_helper = $this->helper('catalog/output');

    $_collectionSize = $_productCollection->count();
    $_columnCount = $this->getColumnCount();

    /* Admin Controllers for timer are declared here */
    $countdownFormatting    = Mage::getStoreConfig('countdown/general/formating');
    $countdownDesign        = Mage::getStoreConfig('countdown/general/design');
    
    /* Admin Controllers for timer are declared here */
    $countdownIsActive      = Mage::getStoreConfig('countdown/general/activate');
    $countdownIsActiveTitle = Mage::getStoreConfig('countdown/general/heading');
    $countdownIsActiveDesc  = Mage::getStoreConfig('countdown/general/caption');
    $countdownTitle         = Mage::getStoreConfig('countdown/general/title');

    $countdownTitleDay  = Mage::getStoreConfig('countdown/general/days');
    $countdownTitleHour = Mage::getStoreConfig('countdown/general/hours');
    $countdownTitleMin  = Mage::getStoreConfig('countdown/general/mins');
    $countdownTitleSec  = Mage::getStoreConfig('countdown/general/sec');

    $colorDescription   = Mage::getStoreConfig('countdown/colors/caption'); //
    $colorCountdown     = Mage::getStoreConfig('countdown/colors/text'); //
    
    $colorHeader        = Mage::getStoreConfig('countdown/colors/title'); // first line - title above countdown
?>
<?php if(!$_productCollection->count()): ?>
    <div class="alert alert-danger"><?php echo $this->__('There are no products matching the selection.') ?></div>
<?php else: ?>
    <?php echo $this->getToolbarHtml() ?>
	<?php // Grid Mode ?>
	<div id="product-list" class="thumbnails">
	<?php $i=0; foreach ($_productCollection as $_product): ?>
    <?php if ($i++%$_columnCount==0): ?><div class="row"><?php endif ?>
        <?php $toDate = $_product->getSpecialTODate();?>
        <div class="col-sm-<?=12/$_columnCount;?> hreview-aggregate hproduct item<?php if(($i-1)%$_columnCount==0): ?> first<?php elseif($i%$_columnCount==0): ?> last<?php endif; ?>">
			<div class="thumbnail">
                <div class="onsale-category-container-list">
                    <?php echo Mage::helper('onsale')->getCategoryLabelHtml($_product); ?>
					<a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" class="product-image">
						<img src="<?php echo $this->helper('catalog/image')->init($_product, 'small_image')->resize(720); ?>" alt="<?php echo $this->stripTags($this->getImageLabel($_product, 'small_image'), null, true) ?>" />
					</a>
                </div>
                <div class="clearfix"></div>
                <p class="title product-name sync-height">
                    <a href="<?php echo $_product->getProductUrl() ?>" title="<?php echo $this->stripTags($_product->getName(), null, true) ?>"><?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?></a>
                </p>
                <?php echo $this->getPriceHtml($_product, true) ?>
            </div>
                    <?php if ($toDate && $countdownIsActive): ?>

                        <?php if ($_product->getPrice() > $_product->getSpecialPrice()) : ?>
                            <?php if ($_product->getSpecialPrice() != 0 || $_product->getSpecialPrice() != "") : ?>



                                <?php
                                    $targetTime = strtotime(Date("m/d/y", strtotime($toDate)) . ' 11:59:00 PM');
                                    $startTime  = strtotime(Date("m/d/y h:i:s A", strtotime(Mage_Core_Model_Locale::date(null, null, "en_US", true))));
                                    $diff   = $targetTime - $startTime;
                                ?>


                                <?php if($diff > 0) : ?>



                                    <?php
                                    /**
                                    * TEXT COUNTDOWN VERSION
                                    */
                                    ?>

                                    <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::TEXT) : ?>



                                        <div class="CountdownBase Text TextH4">
                                            <div class="CountdownTextBasic">

                                                <?php if ($countdownIsActiveTitle == 'showall' || $countdownIsActiveTitle == 'listpage' && $countdownIsActiveTitle != 'hideall' && $countdownTitle != '') : ?>
                                                    <div id="heading<?php echo $count; ?>" class="HeadingTitle" style="color:#<?php echo $colorHeader; ?>;"><?php echo $countdownTitle ?></div>
                                                <?php endif; ?>

                                                <div id="countbox_<?php echo $count; ?>" class="Countdown" style="color: #<?php echo $colorCountdown;?>;"></div>

                                                <?php if ($countdownIsActiveDesc == 'showall' || $countdownIsActiveDesc == 'listpage' && $countdownIsActiveDesc != 'hideall') : ?>
                                                    <?php /*<div class="clear"></div> */ ?>
                                                    <div class="description" id="caption<?php echo $count; ?>" style="color: #<?php echo $colorDescription?>;">
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC) : ?>
                                                        <div class="days"><?php echo $countdownTitleDay?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC) :?>
                                                        <div class="hours"><?php echo $countdownTitleHour?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC) : ?>
                                                        <div class="minutes"><?php echo $countdownTitleMin?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC) : ?>
                                                        <div class="seconds"><?php echo $countdownTitleSec?></div>
                                                        <?php endif; ?>
                                                    </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>

                                    <?php endif;?>


                                    <?php
                                    /**
                                    * TEXT COUNTDOWN VERSION WITH BACKGROUND
                                    */
                                    ?>

                                    <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::TEXT_BACKGROUND) : ?>


                                        <div class="CountdownBase Text">
                                            <div class="CountdownTextBackground">

                                                <?php if ($countdownIsActiveTitle == 'showall' || $countdownIsActiveTitle == 'listpage' && $countdownIsActiveTitle != 'hideall' && $countdownTitle != '') : ?>
                                                    <div id="heading<?php echo $count; ?>" class="HeadingTitle" style="color:#<?php echo $colorHeader; ?>;"><?php echo $countdownTitle ?></div>
                                                <?php endif; ?>

                                                <div id="countbox_<?php echo $count; ?>" class="Countdown" style="color: #<?php echo $colorCountdown;?>;"></div>

                                                <?php if ($countdownIsActiveDesc == 'showall' || $countdownIsActiveDesc == 'listpage' && $countdownIsActiveDesc != 'hideall') : ?>
                                                    <?php /*<div class="clear"></div> */ ?>
                                                    <div class="description" id="caption<?php echo $count; ?>" style="color: #<?php echo $colorDescription?>;">
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC) : ?>
                                                        <div class="days"><?php echo $countdownTitleDay?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC) :?>
                                                        <div class="hours"><?php echo $countdownTitleHour?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC) : ?>
                                                        <div class="minutes"><?php echo $countdownTitleMin?></div>
                                                        <?php endif; ?>
                                                        <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC ||
                                                                $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC) : ?>
                                                        <div class="seconds"><?php echo $countdownTitleSec?></div>
                                                        <?php endif; ?>
                                                    </div>
                                                <?php endif; ?>
                                            </div>
                                        </div>

                                    <?php endif; ?>



                                    <?php
                                    /**
                                    * DIGITALS COUNTDOWN VERSION'S
                                    */
                                    ?>

                                    <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::DIGITS_OLD  ||  $countdownDesign == Iksanika_Countdown_Model_System_Config_Design::DIGITS_OLD2): ?>

                                    <?php
//                                                $targetTime = strtotime(Date("m/d/y", strtotime($toDate)) . ' 11:59:00 PM');
//                                                $startTime  = strtotime(Date("m/d/y h:i:s A", strtotime(Mage_Core_Model_Locale::date(null, null, "en_US", true))));
//                                                $diff   = $targetTime - $startTime;
                                        $sec    = $diff % 60;
                                        $min    = floor($diff/60) % 60;
                                        $hours  = floor($diff/(60*60)) % 24;
                                        $days   = floor($diff/(60*60*24)) % 365;
                                    ?>
                                    <div class="CountdownBase Text TextH4">
                                        <div class="CountdownDigitsBasic">
                                            <?php if($countdownIsActiveTitle == 'showall' || $countdownIsActiveTitle == 'listpage' && $countdownIsActiveTitle != 'hideall' && $countdownTitle != '') :?>
                                            <div class="HeadingTitle" id="heading<?php echo $count; ?>" style="color:#<?php echo $colorHeader?>;"><?php echo $countdownTitle ?></div>
                                            <?php endif; ?>

                                            <?php
                                                $displayFormat = false;
                                                if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC)
                                                {
                                                    $displayFormat = "99.23:59:59";
                                                    $displayTime = ($days < 10 ? '0':'').$days.'.'.($hours < 10 ? '0':'').$hours.':'.($min < 10 ? '0':'').$min.':'.($sec < 10 ? '0':'').$sec;
                                                }else
                                                if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC)
                                                {
                                                    $displayFormat = "23:59:59";
                                                    $displayTime = ($hours < 10 ? '0':'').$hours.':'.($min < 10 ? '0':'').$min.':'.($sec < 10 ? '0':'').$sec;
                                                }else
                                                if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC)
                                                {
                                                    $displayFormat = "59:59";
                                                    $displayTime = ($min < 10 ? '0':'').$min.':'.($sec < 10 ? '0':'').$sec;
                                                }else
                                                if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC)
                                                {
                                                    $displayFormat = "59";
                                                    $displayTime = ($sec < 10 ? '0':'').$sec;
                                                }else
                                                {
                                                    $displayFormat = "99.23:59:59";
                                                    $displayTime = ($days < 10 ? '0':'').$days.'.'.($hours < 10 ? '0':'').$hours.':'.($min < 10 ? '0':'').$min.':'.($sec < 10 ? '0':'').$sec;
                                                }
                                            ?>

                                            <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::DIGITS_OLD) : ?>
                                            <span class="counter<?php echo $count; ?> counter-analog" data-direction="down" data-format="<?php echo $displayFormat;?>"><?php echo $displayTime;?></span>
                                            <?php endif;?>
                                            <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::DIGITS_OLD2) : ?>
                                            <span class="counter<?php echo $count; ?> counter-analog2" data-direction="down" data-format="<?php echo $displayFormat;?>"><?php echo $displayTime;?></span>
                                            <?php endif;?>

                                            <?php if($countdownIsActiveDesc == 'showall' || $countdownIsActiveDesc == 'listpage') :?>
                                            <div class="description" style="color: #<?php echo $colorDescription?>;">
                                                <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC) : ?>
                                                <div class="days"><?php echo $countdownTitleDay?></div>
                                                <?php endif; ?>
                                                <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC) :?>
                                                <div class="hours"><?php echo $countdownTitleHour?></div>
                                                <?php endif; ?>
                                                <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC) : ?>
                                                <div class="minutes"><?php echo $countdownTitleMin?></div>
                                                <?php endif; ?>
                                                <?php if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC ||
                                                            $countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC) : ?>
                                                <div class="seconds"><?php echo $countdownTitleSec?></div>
                                                <?php endif; ?>
                                            </div>
                                            <?php endif;?>
                                        </div>
                                    </div>
                                    <script>
                                        $j('.counter<?php echo $count; ?>').counter();
                                    </script>
                                    <?php $count = $count + 1; ?>


                                <?php endif; ?>


                            <?php endif; ?>


                        <?php endif; ?>
                    <?php endif; ?>




                <?php endif;?>
                <?php if ($toDate && $countdownIsActive): ?>

                        <?php if ($_product->getPrice() > $_product->getSpecialPrice()) : ?>
                            <?php if ($_product->getSpecialPrice() != 0 || $_product->getSpecialPrice() != "") : ?>

                                <?php
                                /**
                                * TEXT COUNTDOWN VERSION
                                */
                                ?>

                                <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::TEXT) : ?>



                                    <script type="text/javascript">
                                        var dthen<?php echo $count; ?> = new Date("<?php echo Date("m/d/y", strtotime($toDate)) . ' 11:59:00 PM'; ?>");
                                        start = "<?php echo Date("m/d/y h:i:s A", strtotime(Mage_Core_Model_Locale::date(null, null, "en_US", true))); ?>";
                                        start_date = Date.parse(start);
                                        var dnow<?php echo $count; ?> = new Date(start_date);
                                        if(CountStepper>0)
                                            ddiff= new Date((dnow<?php echo $count; ?>)-(dthen<?php echo $count; ?>));
                                        else
                                            ddiff = new Date((dthen<?php echo $count; ?>)-(dnow<?php echo $count; ?>));
                                        gsecs<?php echo $count; ?> = Math.floor(ddiff.valueOf()/1000);


                                        <?php
                                            $displayFormat = false;
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC)
                                            {
                                                $displayFormat = "<span class='day'>%%D%%</span><span class='sep'>:</span><span class='hour'>%%H%%</span><span class='sep'>:</span><span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC)
                                            {
                                                $displayFormat = "<span class='hour'>%%H%%</span><span class='sep'>:</span><span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC)
                                            {
                                                $displayFormat = "<span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC)
                                            {
                                                $displayFormat = "<span class='sec'>%%S%%</span>";
                                            }
                                        ?>

                                        <?php if($displayFormat) : ?>
                                        DisplayFormat = "<?php echo $displayFormat;?>";
                                        <?php endif;?>

                                        var iid<?php echo $count; ?> = "countbox_<?php echo $count; ?>";
                                        CountBack(gsecs<?php echo $count; ?>,"countbox_"+j, j);
                                        j++;
                                    </script>
                                    <?php $count = $count + 1; ?>

                                <?php endif; ?>






                                <?php
                                /**
                                * TEXT COUNTDOWN VERSION WITH BACKGROUND
                                */
                                ?>

                                <?php if($countdownDesign == Iksanika_Countdown_Model_System_Config_Design::TEXT_BACKGROUND) : ?>



                                    <script type="text/javascript">
                                        var dthen<?php echo $count; ?> = new Date("<?php echo Date("m/d/y", strtotime($toDate)) . ' 11:59:00 PM'; ?>");
                                        start = "<?php echo Date("m/d/y h:i:s A", strtotime(Mage_Core_Model_Locale::date(null, null, "en_US", true))); ?>";
                                        start_date = Date.parse(start);
                                        var dnow<?php echo $count; ?> = new Date(start_date);
                                        if(CountStepper>0)
                                            ddiff= new Date((dnow<?php echo $count; ?>)-(dthen<?php echo $count; ?>));
                                        else
                                            ddiff = new Date((dthen<?php echo $count; ?>)-(dnow<?php echo $count; ?>));
                                        gsecs<?php echo $count; ?> = Math.floor(ddiff.valueOf()/1000);


                                        <?php
                                            $displayFormat = false;
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::DAYS_HOURS_MIN_SEC)
                                            {
                                                $displayFormat = "<span class='day'>%%D%%</span><span class='hour'>%%H%%</span><span class='sep'>:</span><span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::HOURS_MIN_SEC)
                                            {
                                                $displayFormat = "<span class='hour'>%%H%%</span><span class='sep'>:</span><span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::MIN_SEC)
                                            {
                                                $displayFormat = "<span class='min'>%%M%%</span><span class='sep'>:</span><span class='sec'>%%S%%</span>";
                                            }else
                                            if($countdownFormatting == Iksanika_Countdown_Model_System_Config_Formating::SEC)
                                            {
                                                $displayFormat = "<span class='sec'>%%S%%</span>";
                                            }
                                        ?>

                                        <?php if($displayFormat) : ?>
                                        DisplayFormat = "<?php echo $displayFormat;?>";
                                        <?php endif;?>

                                        var iid<?php echo $count; ?> = "countbox_<?php echo $count; ?>";
                                        CountBack(gsecs<?php echo $count; ?>,"countbox_"+j, j);
                                        j++;
                                    </script>
                                    <?php $count = $count + 1; ?>

                                <?php endif;?>



                            <?php endif;?>
                        <?php endif;?>


                    <?php endif; ?>
                </div>
        <?php if ($i%$_columnCount==0 || $i==$_collectionSize): ?></div><?php endif ?>
    <?php endforeach ?>
	</div>
    <?php echo $this->getToolbarHtml() ?>
<?php endif; ?>
